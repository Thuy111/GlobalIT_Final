<th:block th:replace="~{/layout/basic :: setContent(~{/layout/topbar :: title(title=${title})}, ~{this::content})}">
  <th:block th:fragment="content">

    <div class="chatRoom_container">
      <div class="messageArea">
        <div th:each="message : ${messages}"
            class="msg"
            th:classappend="${currentUser.emailId} == ${message.sender} ? 'me' : 'you'"
            th:text="${message.message}">
        </div>
      </div>

      <div class="inputArea">
        <input type="text" placeholder="보낼 메세지를 입력하세요." class="content">
        <button type="button" value="전송" class="sendBtn" onclick="sendmessage()"><i class="fa-solid fa-paper-plane"></i></button>
        <!-- <button type="button" value="방나가기" class="quit" onclick="quit()">방 나가기 </button> -->
      </div>
    </div>

    <script th:inline="javascript">
        // Thymeleaf 변수 JS로 전달
        const roomId = /*[[${room.roomId}]]*/ "";
        const sender = /*[[${myUser}]]*/ "";

        function enterRoom(socket){
            const entermessage = {"roomId": roomId, "sender": sender, "message": "", "messageType": "ENTER", "senderNickname": /*[[${myUser}]]*/ ""};
            socket.send(JSON.stringify(entermessage));
        }

        let socket = new WebSocket("ws://localhost:8080/ws/chat");

        socket.onopen = function (e) {
            console.log('open server!');
            enterRoom(socket);
        };
        socket.onclose = function(e){
            console.log('disconnect');
        }
        socket.onerror = function (e){
            console.log(e);
        }
        //메세지 수신 이벤트
        socket.onmessage = function (e) {
            console.log(e.data);
            let messageArea = document.querySelector('.messageArea');
            let newmessage = document.createElement('div');
            // e.data는 json string이라고 가정
            try {
                let payload = JSON.parse(e.data);
                // 내 메시지면 "me", 상대면 "you" 클래스 붙이기
                let isMe = payload.sender === sender;
                newmessage.className = isMe ? "msg me" : "msg you";
                // 출력
                newmessage.innerText = payload.message;
            } catch {
                newmessage.innerText = e.data;
            }
            messageArea.append(newmessage);
        }

        //메세지 보내기 버튼
        function sendmessage() {
            let content = document.querySelector('.content').value;
            if (!content) return;
            const talkmessage = {"roomId": roomId, "sender": sender, "message": content, "messageType": "TALK", "senderNickname": /*[[${myUser}]]*/ ""};
            socket.send(JSON.stringify(talkmessage));
            document.querySelector('.content').value = '';
        }
        // 엔터키로 메세지 전송
        document.querySelector('.content').addEventListener('keydown', function(e){
            if(e.key === 'Enter') sendmessage();
        });

        // 방 나가기 버튼 (필요X)
        function quit(){
            const quitmessage = {"roomId": roomId, "sender": sender, "message": "", "messageType": "QUIT", "senderNickname": /*[[${myUser}]]*/ ""};
            socket.send(JSON.stringify(quitmessage));
            socket.close();
        }
    </script>
  </th:block>
</th:block>