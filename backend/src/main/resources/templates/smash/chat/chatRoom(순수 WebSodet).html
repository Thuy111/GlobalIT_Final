<th:block th:replace="~{/layout/basic :: setContent(~{/layout/topbar :: title(title=${title})}, ~{this::content})}">
  <th:block th:fragment="content">

    <div class="chatRoom_container">
      <div class="chat_start"><span>대화가 시작 되었습니다.</span></div>
      <div class="messageArea"></div>

      <!-- <div class="messageArea" th:each="message, iterStat : ${messages}">
        <div th:if="${iterStat.index == 0 or #temporals.format(messages[iterStat.index-1].time, 'yyyy/MM/dd') != #temporals.format(message.time, 'yyyy/MM/dd')}"
            class="date_label"
            th:text="${#temporals.format(message.time, 'yyyy/MM/dd')}"></div>

        <div class="msg_box"
        th:classappend="${currentUser.emailId} == ${message.sender} ? 'me' : 'you'">
          <div class="info_box">
            <div class="idRead">전송됨</div>
            <div th:if="${currentUser.emailId} == ${message.sender}" class="created_at" th:text="${#temporals.format(message.time, 'HH:mm')}"></div>
          </div>
          <div
          class="msg"
          th:classappend="${currentUser.emailId} == ${message.sender} ? 'me' : 'you'"
          th:text="${message.message}">
          </div>
          <div class="info_box">
            <div th:if="${currentUser.emailId} != ${message.sender}" class="created_at" th:text="${#temporals.format(message.time, 'HH:mm')}"></div>
          </div>
        </div>
      </div> -->

      <div th:if="${title != '탈퇴한 사용자'}" class="inputArea">
        <input type="text" placeholder="보낼 메세지를 입력하세요." class="content">
        <button type="button" value="전송" class="sendBtn" onclick="sendmessage()"><i class="fa-solid fa-paper-plane"></i></button>
        <!-- <button type="button" value="방나가기" class="quit" onclick="quit()">방 나가기 </button> -->
      </div>
    </div>

    <script th:inline="javascript">
      let messageArea = document.querySelector('.messageArea');

      // (메세지) 단순 렌더링. 이전 메시지 불러오기용
      function renderMessages(messages) {
      let lastDateStr = '';
      messages.forEach((msg, idx) => {
        // console.log(msg);


        const dateObj = new Date(msg.time);
        const dateStr = dateObj.getFullYear() + '/' +
                        String(dateObj.getMonth() + 1).padStart(2, '0') + '/' +
                        String(dateObj.getDate()).padStart(2, '0');
        if (lastDateStr !== dateStr) {
          let dateLabel = document.createElement('div');
          dateLabel.className = 'date_label';
          dateLabel.innerText = dateStr;
          messageArea.append(dateLabel);
          lastDateStr = dateStr;
        }

        let hours = dateObj.getHours();
        const minutes = String(dateObj.getMinutes()).padStart(2, '0');
        const ampm = hours < 12 ? '오전' : '오후';
        hours = hours % 12;
        if (hours === 0) hours = 12;
        const timeStr = `${ampm} ${hours}:${minutes}`;

        let msgBox = document.createElement('div');
        msgBox.className = 'msg_box ' + (msg.sender === sender ? 'me' : 'you');
        msgBox.id = 'msg_' + msg.id; // 메시지 ID로 고유하게 식별 (읽음 처리를 위함)

        let infoBox1 = document.createElement('div');
        infoBox1.className = 'info_box';

        if (msg.sender === sender) {
          let idRead = document.createElement('div');
          idRead.className = 'idRead';
          idRead.innerText = msg.read ? '읽음' : '전송됨';
          infoBox1.appendChild(idRead);

          let createdAt = document.createElement('div');
          createdAt.className = 'created_at';
          createdAt.innerText = timeStr;
          infoBox1.appendChild(createdAt);
        }

          let msgDiv = document.createElement('div');
          msgDiv.className = 'msg ' + (msg.sender === sender ? 'me' : 'you');
          msgDiv.innerText = msg.message;

          let infoBox2 = document.createElement('div');
          infoBox2.className = 'info_box';
          if (msg.sender !== sender) {
            let createdAt = document.createElement('div');
            createdAt.className = 'created_at';
            createdAt.innerText = timeStr;
            infoBox2.appendChild(createdAt);
          }

          msgBox.appendChild(infoBox1);
          msgBox.appendChild(msgDiv);
          msgBox.appendChild(infoBox2);

          messageArea.append(msgBox);
          window.scrollTo(0, document.body.scrollHeight + 64);
        });
      }

      // (메세지) 단일 메시지 추가. 실시간 수신용
      function appendMessage(msg) {
        let lastDateStr = ''; // 같은 날에 여러 번 오면 날짜 라벨은 생략하도록 로직 보완 가능

        const dateObj = new Date(msg.time);
        const dateStr = dateObj.getFullYear() + '/' +
                        String(dateObj.getMonth() + 1).padStart(2, '0') + '/' +
                        String(dateObj.getDate()).padStart(2, '0');

        let hours = dateObj.getHours();
        const minutes = String(dateObj.getMinutes()).padStart(2, '0');
        const ampm = hours < 12 ? '오전' : '오후';
        hours = hours % 12;
        if (hours === 0) hours = 12;
        const timeStr = `${ampm} ${hours}:${minutes}`;
        const isMe = msg.sender === sender;

        let msgBox = document.createElement('div');
        msgBox.className = 'msg_box ' + (isMe ? 'me' : 'you');
        msgBox.id = 'msg_' + msg.id; // id 부여

        let infoBox1 = document.createElement('div');
        infoBox1.className = 'info_box';

        if (isMe) {
          let idRead = document.createElement('div');
          idRead.className = 'idRead';
          idRead.innerText = msg.read ? '읽음' : '전송됨'; // 처음은 '전송됨'
          infoBox1.appendChild(idRead);

          let createdAt = document.createElement('div');
          createdAt.className = 'created_at';
          createdAt.innerText = timeStr;
          infoBox1.appendChild(createdAt);
        }

        let msgDiv = document.createElement('div');
        msgDiv.className = 'msg ' + (isMe ? 'me' : 'you');
        msgDiv.innerText = msg.message;

        let infoBox2 = document.createElement('div');
        infoBox2.className = 'info_box';
        if (!isMe) {
          let createdAt = document.createElement('div');
          createdAt.className = 'created_at';
          createdAt.innerText = timeStr;
          infoBox2.appendChild(createdAt);
        }

        msgBox.appendChild(infoBox1);
        msgBox.appendChild(msgDiv);
        msgBox.appendChild(infoBox2);

        messageArea.append(msgBox);
        window.scrollTo(0, document.body.scrollHeight + 64);
      }

      // Thymeleaf 변수 JS로 전달
      const roomId = /*[[${room.roomId}]]*/ "";
      const sender = /*[[${createUser}]]*/ "";

      // 1. 메시지 불러오기 (axios)
      document.addEventListener('DOMContentLoaded', function() {
        // 페이지가 로드되면 메시지를 불러오면서 스크롤을 맨 아래로 내림.
        window.scrollTo(0, document.body.scrollHeight + 64); // 4rem
        
        
        axios.get(`/smash/chat/rooms/${roomId}/messages`)
        .then(res => {
          messageArea.innerHTML = '';
          const messages = res.data;
          renderMessages(messages); // 메시지 전체 렌더링
          let messageInput = document.querySelector('.inputArea input'); // 메시지 영역 선택
          messageInput.value = ''; // 입력창 비우기
        })
        .then(() => {
          // 2. WebSocket 연결 및 이벤트 등록
          connectWebSocket();
        });
      }); // ===DOMContentLoaded end===

      function connectWebSocket() {
        let socket = new WebSocket("ws://localhost:8080/ws/chat");
        window.socket = socket; // sendmessage 등에서 접근 가능하게

        socket.onopen = function (e) {
            console.log('open server!');
            enterRoom(socket);
        };
        socket.onclose = function(e){
            console.log('disconnect');
        }
        socket.onerror = function (e){
            console.log(e);
        }
        socket.onmessage = function (e) { // 메시지 수신 이벤트
          let payload;
          try {
              payload = JSON.parse(e.data);
          } catch {
              console.error('Invalid JSON received:', e.data);
              // 에러 처리
              return;
          }
          // renderMessages([payload]); // 단일 메시지도 배열로 감싸서 전달

          // 읽음 처리
          if (payload.messageType === "READ" && Array.isArray(payload.messageIds)) {
            // 읽음 처리: 해당 메시지의 idRead 텍스트를 '읽음'으로 변경
            payload.messageIds.forEach(id => {
              let msgBox = document.getElementById('msg_' + id);
              if (msgBox) {
                let idReadDiv = msgBox.querySelector('.idRead');
                if (idReadDiv) idReadDiv.innerText = '읽음';
              }
            });
            return;
          }

          // TALK 등 다른 메시지는 기존대로 append
          appendMessage(payload);
        }
      }

      function enterRoom(socket){
        const entermessage = {
          "roomId": roomId,
          "sender": sender,
          "message": "",
          "messageType": "ENTER",
          "senderNickname": sender // createUser
        };
        socket.send(JSON.stringify(entermessage));

        // 읽음 처리 요청
        axios.post(`/smash/chat/rooms/${roomId}/read`, sender )
          .then(() => {
            // 읽음 처리 후, 메시지 목록을 다시 불러와서 렌더링
            return axios.get(`/smash/chat/rooms/${roomId}/messages`);
          })
          .then(res => {
            messageArea.innerHTML = '';
            renderMessages(res.data);
          });
        }

        //메세지 보내기 버튼
        function sendmessage() {
            let content = document.querySelector('.content').value;
            if (!content) return;
            const talkmessage = {"roomId": roomId, "sender": sender, "message": content, "messageType": "TALK", "senderNickname": /*[[${createUser}]]*/ ""};
            window.socket.send(JSON.stringify(talkmessage));
            document.querySelector('.content').value = '';

            // 스크롤을 맨 아래로 내리기
            window.scrollTo(0, document.body.scrollHeight + 64); // 4rem
        }

        // 엔터키로 메세지 전송
        document.querySelector('.content').addEventListener('keydown', function(e){
            if(e.key === 'Enter') sendmessage();
        });

        // 방 나가기 버튼 (필요X)
        function quit(){
            const quitmessage = {"roomId": roomId, "sender": sender, "message": "", "messageType": "QUIT", "senderNickname": /*[[${createUser}]]*/ ""};
            window.socket.send(JSON.stringify(quitmessage));
            window.socket.close();
        }
    </script>
  </th:block>
</th:block>