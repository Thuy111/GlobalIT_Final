<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<th:block th:replace="~{/layout/basic :: setContent(~{this::content} )}">
  <th:block th:fragment="content">
    <div class="estimate_container">
      <h1>
        <a href="/smash/estimate/list">〈 </a>
        견적서 작성
      </h1>
      
      <div class="estimate_form">
        <form th:action="@{/smash/estimate/register}" enctype="multipart/form-data" method="post">
          <input type="hidden" name="requestIdx" value="1" required>
          <input type="hidden" name="partnerBno" value="234-56-78901" required>
          <input type="hidden" name="isSelected" value="0">
          <input type="hidden" name="isReturn" value="false">
          <input type="hidden" class="datetime" name="createdAt">
          <input type="hidden" class="datetime" name="modifiedAt">

          <div id="image_preview" class="image_preview_wrapper">
            <div id="image_control" class="camera_wrapper">
              <label id="upload_images" class="image_upload_box">
                <i class="fa-solid fa-camera"></i>
                <span><span id="image_count">0</span>/10</span>
                <input type="file" name="image_files" multiple hidden>
              </label>
              <p id="reset_images" class="image_reset_btn">이미지 초기화</p>
            </div>
            <div class="attached_image_area">
            </div>
          </div>

          <label>
            제목<br>
            <input type="text" name="title" required>
          </label><br>
          
          <label>
            내용<br>
            <textarea name="content" required></textarea>
          </label><br>
  
          <label>
            가격<br>
            <input type="text" name="price" required>원
          </label><br>
          
          대여 방법<br>
          <input type="checkbox" name="isDelivery" value="true">배달
          <input type="checkbox" name="isPickup" value="true">픽업<br>
    
          반납 날짜<br>
          <input type="datetime-local" name="returnDate" required><br>
          
          <button type="submit">작성 완료</button>
        </form>
      </div>
    </div>
    
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // 첨부 이미지관련 기능
        const imageInput = document.querySelector('input[name="image_files"]');
        const attachedArea = document.querySelector('.attached_image_area');
        const imageCountDisplay = document.getElementById('image_count');
        const MAX_IMAGES = 10;
        // 이미지 선택 시 미리보기 처리
        imageInput.addEventListener('change', function (event) {
          const files = event.target.files;
          if (files.length > MAX_IMAGES) {
            alert("이미지는 최대 10개까지만 업로드할 수 있습니다.");
            imageInput.value = '';
            return;
          }
          // 기존 이미지 초기화
          attachedArea.innerHTML = '';
          if (files.length > 0) {
            Array.from(files).forEach(file => {
              const reader = new FileReader();
              reader.onload = function (e) {
                const wrapper = document.createElement('div');
                wrapper.classList.add('attached_image');
                const imgElement = document.createElement('img');
                imgElement.src = e.target.result;
                imgElement.alt = "첨부 이미지";
                wrapper.appendChild(imgElement);
                attachedArea.appendChild(wrapper);
              };
              reader.readAsDataURL(file);
            });
            imageCountDisplay.textContent = files.length;
          } else {
            imageCountDisplay.textContent = '0';
          }
        });

        // 이미지 초기화 버튼 처리
        const resetBtn = document.getElementById('reset_images');
        resetBtn.addEventListener('click', function () {
          imageInput.value = '';
          attachedArea.innerHTML = '';
          const noImageDiv = document.createElement('div');
          noImageDiv.classList.add('no_image');
          attachedArea.appendChild(noImageDiv);
          imageCountDisplay.textContent = '0';
        });

        // 현재 시간을 모든 datetime input에 입력
        const now = new Date();
        const offset = now.getTimezoneOffset();
        now.setMinutes(now.getMinutes() - offset);
        const datetimeInputs = document.getElementsByClassName('datetime');
        const datetimeValue = now.toISOString().slice(0, 16);
        for (let i = 0; i < datetimeInputs.length; i++) {
          datetimeInputs[i].value = datetimeValue;
        }

        // 입력값 검증
        const form = document.querySelector("form");
        form.addEventListener("submit", function (e) {
          const isDelivery = form.querySelector('input[name="isDelivery"]').checked;
          const isPickup = form.querySelector('input[name="isPickup"]').checked;
          // 둘 다 체크되지 않았을 경우 전송 막기
          if (!isDelivery && !isPickup) {
            e.preventDefault(); // submit 막기
            alert("배달 또는 픽업 중 하나는 반드시 선택해야 합니다.");
          }
          // 체크되지 않은 항목은 'false'로 전송
          ['isDelivery', 'isPickup'].forEach(name => {
            const checkbox = form.querySelector(`input[name="${name}"]`);
            if (!checkbox.checked && !form.querySelector(`input[type="hidden"][name="${name}"]`)) {
              const hidden = document.createElement("input");
              hidden.type = "hidden";
              hidden.name = name;
              hidden.value = "false";
              form.appendChild(hidden);
            }
          });
        });
      });
    </script>
  </th:block>
</th:block>