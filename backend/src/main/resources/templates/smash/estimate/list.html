<th:block th:replace="~{/layout/basic :: setContent(~{/layout/topbar :: title(title=${title})}, ~{this::content})}">
  <th:block th:fragment="content">
    <div class="estimate_container">
      <div class="estimate_list" th:if="${not #lists.isEmpty(result)}">
        <div class="estimate_box" th:each="estimate : ${result}"
                                  th:attr="data-href=@{/smash/request/detail/{idx}(idx=${estimate.requestIdx})}">
          <div class="estimate_card">
            <div class="estimate_header">
              <div class="estimate_meta">
                <b class="estimate_title">[[${estimate.title}]]</b>
                <span class="standby" th:if="${estimate.isSelected == 0}">낙찰 대기</span>
                <span class="unselected" th:if="${estimate.isSelected == 1}">미 낙찰</span>
                <span class="selected" th:if="${estimate.isSelected == 2}">낙찰 완료</span>
              </div>
            </div>
            
            <hr class="estimate_divider" />

            <div class="estimate_body">
              <div class="estimate_actions" th:if="${(currentUser != null and estimate.partnerBno == currentUser.bno) or 
                                                    (currentUser != null and currentUser.role == 2)}">
                <form th:action="@{/smash/estimate/update}" method="get">
                  <input type="hidden" name="idx" th:value="${estimate.idx}" />
                  <button type="submit" th:if="${estimate.isSelected == 0}">수정</button>
                </form>
                <form th:action="@{/smash/estimate/delete}" method="post" th:id="'delete-'+ ${estimate.idx}">
                  <input type="hidden" name="idx" th:value="${estimate.idx}" />
                  <button type="submit">삭제</button>
                </form>
              </div>
              <div class="estimate_info">
                <div>
                  <span class="badge">제시 가격</span>
                  <div style="font-size: 18px;">
                    <span class="price">[[${#numbers.formatInteger(estimate.price, 3, 'COMMA')}]]</span> 원
                  </div>
                </div>
                <div>
                  <span class="badge">반납 기한</span>
                  <span>[[${T(java.time.format.DateTimeFormatter).ofPattern('yyyy년 MM월 dd일 HH:mm').format(estimate.returnDate)}]]</span>
                </div>
                <div>
                  <span class="badge">대여 방법</span>
                  <p class="deal_method">
                    <span class="delivery yes" th:if="${estimate.isDelivery == true}">배달 가능</span>
                    <span class="delivery no" th:if="${estimate.isDelivery == false}">배달 불가</span>
                    <span class="pickup yes" th:if="${estimate.isPickup == true}">픽업 가능</span>
                    <span class="pickup no" th:if="${estimate.isPickup == false}">픽업 불가</span>
                  </p>
                </div>
                <div class="estimate_content">
                  <pre>[[${estimate.content}]]</pre>
                </div>
              </div>
  
              <div class="attached_image_area" th:if="${not #lists.isEmpty(estimate.images)}">
                <div class="attached_image" th:each="image : ${estimate.images}">
                  <img class="zoomable_image" th:src="@{${image.path}}" alt="첨부 이미지"/>
                </div>
              </div>
              <div id="lightbox" class="lightbox" onclick="closeLightbox()">
                <img id="lightbox_img" src="" alt="zoom" />
              </div>
  
              <div class="partner_info">
                <div class="partner_name"
                    th:attr="data-href=@{/smash/store/{code}(code=${estimate.partnerCode}, memberId=${currentUser != null && currentUser.emailId != null ? currentUser.emailId : ''})}">
                  <div class="store_icon_box">
                    <i class="fa-solid fa-store"></i>
                  </div>
                  <p class="name" th:text="${estimate.partnerName}"></p>
                </div>
                <div class="patner_tel">
                  <span class="badge">연락처</span>
                  <span th:text="${estimate.partnerTel}"></span>
                </div>
                <div>
                  <span class="badge">주소</span>
                  <span th:text="${estimate.partnerRegion}"></span>
                </div>
              </div>
  
              <p class="estimate_date">
                [[${T(java.time.format.DateTimeFormatter).ofPattern('yyyy년 MM월 dd일 HH:mm').format(estimate.modifiedAt)}]]
                <small th:if="${!estimate.createdAt.equals(estimate.modifiedAt)}">(수정 됨)</small>
              </p>
            </div>
          </div>

          <!-- 견적서 작성자가 처리하는 (반납확인) 버튼 -->
          <div th:if="${(currentUser != null and estimate.partnerBno == currentUser.bno) or 
                        (currentUser != null and currentUser.role == 2)}">
            <form th:action="@{/smash/estimate/return}" method="post" th:id="'return-' + ${estimate.idx}" class="estimate_actions select_form">
              <input type="hidden" name="idx" th:value="${estimate.idx}" />
              <input type="hidden" name="isReturn" th:value="true" />
              <button type="submit" 
                th:if="${estimate.isReturn == false and 
                         estimate.isSelected == 2}">
                반납 확인
              </button>
            </form>
          </div><!-- 견적서 작성자가 처리하는 (반납확인) 버튼 끝 -->
        </div>
      </div>
      
      <div class="bottom_space"></div>

      <script>
        document.addEventListener("DOMContentLoaded", function () {
          // 이미지 lightbox. Js code((이미지 크게 보기)
          const images = document.querySelectorAll(".zoomable_image");
          const lightbox = document.getElementById("lightbox");
          const lightboxImg = document.getElementById("lightbox_img");
          images.forEach(img => {
            img.addEventListener("click", () => {
              lightbox.style.display = "flex";
              lightboxImg.src = img.src;
            });
          });
          window.closeLightbox = function () {
            lightbox.style.display = "none";
            lightboxImg.src = "";
          };

          // 삭제 confirm
          const deleteForms = document.querySelectorAll("form[id^='delete-']");
          deleteForms.forEach(form => {
            form.addEventListener("submit", function (e) {
              if (!confirm("정말로 이 견적서를 삭제하시겠습니까?")) {
                e.preventDefault();
              }
            });
          });

          // 반납 confirm
          const returnForms = document.querySelectorAll("form[id^='return-']");
          returnForms.forEach(form => {
            form.addEventListener("submit", function (e) {
              if (!confirm("반납을 확인 처리하시겠습니까?")) {
                e.preventDefault();
              }
            });
          });

          // estimate_box 클릭 시 의뢰서 상세보기 페이지로 이동
          const boxes = document.querySelectorAll(".estimate_box");
          boxes.forEach(box => {
            box.addEventListener("click", function(e) {
              // 내부 폼/버튼 클릭 시엔 무시 (form, button 등)
              if (
                e.target.tagName === "BUTTON" ||
                e.target.closest("form") ||
                e.target.classList.contains("zoomable_image")
              ) {
                return;
              }
              const url = box.getAttribute("data-href");
              if (url) {
                window.location.href = url;
              }
            });
          });

          // 업체명 클릭 시 해당 업체 소개 페이지로 이동
          document.querySelectorAll(".partner_info .name").forEach(nameElem => {
            nameElem.style.cursor = "pointer"; // UX: 손가락 커서
            nameElem.addEventListener("click", function(e) {
              // 부모 .partner_name에서 data-href 읽기
              const partnerNameDiv = nameElem.closest(".partner_name");
              const url = partnerNameDiv ? partnerNameDiv.getAttribute("data-href") : null;
              if (url) {
                window.location.href = url;
              }
              // 이벤트 버블링 방지(필요시)
              e.stopPropagation();
            });
          });
        });
      </script>
    </div>
  </th:block>
</th:block>