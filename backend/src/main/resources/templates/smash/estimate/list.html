<th:block th:replace="~{/layout/basic :: setContent(~{/layout/topbar :: title(title=${title})}, ~{this::content})}">
  <th:block th:fragment="content">
    <div class="estimate_container">
      <div class="estimate_list">
        <div class="estimate_box" th:each="estimate : ${result}">
          <div class="estimate_card">
            <div class="estimate_header">
              <div class="estimate_meta">
                <span class="standby" th:if="${estimate.isSelected == 0}">낙찰 대기</span>
                <span class="unselected" th:if="${estimate.isSelected == 1}">미 낙찰</span>
                <span class="selected" th:if="${estimate.isSelected == 2}">낙찰 완료</span>
                <b class="estimate_title">[[${estimate.title}]]</b>
              </div>
              <div class="estimate_actions" th:if="${currentUser != null and estimate.partnerBno == currentUser.bno}">
                <form th:action="@{/smash/estimate/update}" method="get" th:id="'update'+ ${estimate.idx}">
                  <input type="hidden" name="idx" th:value="${estimate.idx}" />
                  <button type="submit" th:if="${estimate.isSelected == 0}">수정</button>
                </form>
                <form th:action="@{/smash/estimate/delete}" method="post" th:id="'delete-'+ ${estimate.idx}">
                  <input type="hidden" name="idx" th:value="${estimate.idx}" />
                  <button type="submit">삭제</button>
                </form>
              </div>
            </div>
            <table>
              <tr>
                <th>제시 가격</th>
                <td>[[${estimate.price}]]원</td>
              </tr>
              <tr>
                <th>반납 기한</th>
                <td th:text="${T(java.time.format.DateTimeFormatter).ofPattern('yy년 MM월 dd일 HH:mm').format(estimate.returnDate)}"></td>
              </tr>
              <tr>
                <th>대여 방법</th>
                <td>
                  <span class="delivery" th:if="${estimate.isDelivery == true}">배달 가능</span>
                  <span class="delivery" th:if="${estimate.isDelivery == false}">배달 불가</span>
                  /
                  <span class="pickup" th:if="${estimate.isPickup == true}">픽업 가능</span>
                  <span class="pickup" th:if="${estimate.isPickup == false}">픽업 불가</span>
                </td>
              </tr>
            </table>
            <p class="estimate_content">[[${estimate.content}]]</p>
            <div class="attached_image_area" th:if="${not #lists.isEmpty(estimate.images)}">
              <div class="attached_image" th:each="image : ${estimate.images}">
                <img class="zoomable_image" th:src="@{${image.path}}" alt="첨부 이미지"/>
              </div>
            </div>
            <div id="lightbox" class="lightbox" onclick="closeLightbox()">
              <img id="lightbox_img" src="" alt="zoom" />
            </div>
            <table>
              <caption>업체 정보</caption>
              <tr>
                <th>이름</th>
                <td th:text="${estimate.partnerName}"></td>
              </tr>
              <tr>
                <th>연락처</th>
                <td th:text="${estimate.partnerTel}"></td>
              </tr>
              <tr>
                <th>주소</th>
                <td th:text="${estimate.partnerRegion}"></td>
              </tr>
            </table>
            <p class="estimate_date">
              [[${T(java.time.format.DateTimeFormatter).ofPattern('yy.MM.dd HH:mm').format(estimate.modifiedAt)}]]
              <small th:if="${!estimate.createdAt.equals(estimate.modifiedAt)}">수정 됨</small>
            </p>
          </div>
          <div th:if="${currentUser != null and estimate.partnerBno == currentUser.bno}">
            <form th:action="@{/smash/estimate/return}" method="post" th:id="'return-' + ${estimate.idx}">
              <input type="hidden" name="idx" th:value="${estimate.idx}" />
              <input type="hidden" name="isReturn" th:value="true" />
              <button type="submit" th:if="${estimate.isReturn == false and estimate.isSelected == 2}">반납 확인</button>
            </form>
          </div>
        </div>
      </div>

      <script>
        document.addEventListener("DOMContentLoaded", function () {
          // 이미지 lightbox. Js code((이미지 크게 보기)
          const images = document.querySelectorAll(".zoomable_image");
          const lightbox = document.getElementById("lightbox");
          const lightboxImg = document.getElementById("lightbox_img");
          images.forEach(img => {
            img.addEventListener("click", () => {
              lightbox.style.display = "flex";
              lightboxImg.src = img.src;
            });
          });
          window.closeLightbox = function () {
            lightbox.style.display = "none";
            lightboxImg.src = "";
          };

          // 삭제 confirm
          const deleteForms = document.querySelectorAll("form[id^='delete-']");
          deleteForms.forEach(form => {
            form.addEventListener("submit", function (e) {
              if (!confirm("정말로 이 견적서를 삭제하시겠습니까?")) {
                e.preventDefault();
              }
            });
          });
          // 반납 confirm
          const returnForms = document.querySelectorAll("form[id^='return-']");
          returnForms.forEach(form => {
            form.addEventListener("submit", function (e) {
              if (!confirm("반납을 확인 처리하시겠습니까?")) {
                e.preventDefault();
              }
            });
          });
        });
      </script>
    </div>
  </th:block>
</th:block>