<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<th:block th:replace="~{/layout/basic :: setContent(~{this::content} )}">
  <th:block th:fragment="content">
    <div class="estimate_container">
      <h1>
        <a href="/smash/estimate/list">〈 </a>
        견적서 수정
      </h1>
  
      <div class="estimate_form">
        <form th:action="@{/smash/estimate/modify}" enctype="multipart/form-data" method="post">
          <input type="hidden" name="idx" th:value="${dto.idx}" readonly>
          <input type="hidden" class="datetime" name="modifiedAt" readonly>

          <div id="image_preview">
            <div id="image_control">
              <label id="upload_images">
                <i class="fa-solid fa-camera"></i>
                <span><span id="image_count">0</span>/10</span>
                <input type="file" name="imageFiles" multiple hidden>
              </label>
              <p id="reset_images">이미지 초기화</p>
              <input type="hidden" name="delete_images">
            </div>
            <div class="attached_image_area">
              <div th:if="${#lists.isEmpty(dto.images)}">
              </div>
              <div class="attached_image" th:each="image : ${dto.images}">
                <img th:src="@{${image.path}}" alt="첨부 이미지"/>
                <label>
                  <i class="remove_image fa-solid fa-xmark"></i>
                  <input type="checkbox" name="remove_check" th:value="${image.imageIdx}" hidden>
                </label>
              </div>
            </div>
          </div>

          <label for="title">제목<br>
            <input type="text" name="title" th:value="${dto.title}" required>
          </label><br>
          
          <label for="content">내용<br>
            <textarea name="content" th:text="${dto.content}" required></textarea>
          </label><br>
  
          <label for="price">가격<br>
            <input type="text" name="price" th:value="${dto.price}" required>원
          </label><br>
          
          대여 방법<br>
          <input type="checkbox" name="isDelivery" value="true" th:checked="${dto.isDelivery == true}">배달
          <input type="checkbox" name="isPickup" value="true" th:checked="${dto.isPickup == true}">픽업<br>
    
          반납 날짜<br>
          <input type="datetime-local" name="returnDate" th:value="${dto.returnDate}" required><br>
    
          <button type="submit">수정 완료</button>
        </form>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // 요소 모음
        const form = document.querySelector("form");
        const attachedArea = document.querySelector(".attached_image_area");
        const imageCountSpan = document.getElementById("image_count");
        const uploadInput = document.querySelector('input[type="file"][name="imageFiles"]');
        const deleteInput = document.querySelector('input[type="hidden"][name="delete_images"]');
        const resetBtn = document.getElementById("reset_images");
        // 시간 입력
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        const datetimeValue = now.toISOString().slice(0, 16);
        document.querySelectorAll('.datetime').forEach(input => input.value = datetimeValue);
        // 1. 이미지 개수 표시
        function updateImageCount() {
          let existingCount = 0;
          attachedArea.querySelectorAll(".attached_image").forEach(div => {
            const check = div.querySelector('input[type="checkbox"][name="remove_check"]');
            if (!check || !check.checked) existingCount++;
          });
          let addedCount = attachedArea.querySelectorAll(".added_image").length;
          imageCountSpan.textContent = existingCount + addedCount;
        }
        // 2. 삭제할 이미지 목록 관리
        function updateDeleteImagesInput() {
          const removeIdxs = Array.from(
            attachedArea.querySelectorAll('.attached_image input[type="checkbox"][name="remove_check"]:checked')
          ).map(chk => chk.value);
          deleteInput.value = removeIdxs.join(",");
        }
        // 3. 기존 이미지 삭제 UI
        function setupExistingImageDeleteUI() {
          attachedArea.querySelectorAll(".attached_image").forEach(imgDiv => {
            const check = imgDiv.querySelector('input[type="checkbox"][name="remove_check"]');
            const xIcon = imgDiv.querySelector(".remove_image");
            if (!check || !xIcon) return;
            function toggle() {
              check.checked = !check.checked;
              imgDiv.classList.toggle("remove_check", check.checked);
              xIcon.className = check.checked
                ? "remove_image fa-solid fa-plus"
                : "remove_image fa-solid fa-xmark";
              updateImageCount();
              updateDeleteImagesInput();
            }
            xIcon.onclick = function (e) { e.preventDefault(); toggle(); };
            check.onchange = function () { toggle(); };
          });
        }
        // 4. 신규 이미지 업로드 및 미리보기
        if (uploadInput) {
          uploadInput.addEventListener("change", function () {
            const files = Array.from(uploadInput.files);
            let existingCount = 0;
            attachedArea.querySelectorAll(".attached_image").forEach(div => {
              const check = div.querySelector('input[type="checkbox"][name="remove_check"]');
              if (!check || !check.checked) existingCount++;
            });
            let addedCount = attachedArea.querySelectorAll(".added_image").length;
            if ((existingCount + addedCount + files.length) > 10) {
              alert("이미지는 최대 10개까지 첨부할 수 있습니다.");
              uploadInput.value = "";
              return;
            }
            files.forEach(file => {
              const reader = new FileReader();
              reader.onload = function (evt) {
                const div = document.createElement("div");
                div.className = "added_image";
                div.innerHTML = `
                  <img src="${evt.target.result}" alt="추가 이미지 미리보기"/>
                  <i class="remove_image fa-solid fa-xmark"></i>
                `;
                div.querySelector(".remove_image").onclick = function () {
                  div.remove();
                  updateImageCount();
                };
                attachedArea.appendChild(div);
                updateImageCount();
              };
              reader.readAsDataURL(file);
            });
          });
        }
        // 5. 이미지 초기화 버튼
        if (resetBtn) {
          resetBtn.onclick = function () {
            attachedArea.querySelectorAll(".attached_image").forEach(div => {
              const check = div.querySelector('input[type="checkbox"][name="remove_check"]');
              if (check && check.checked) {
                check.checked = false;
                div.classList.remove("remove_check");
                div.querySelector(".remove_image").className = "remove_image fa-solid fa-xmark";
              }
            });
            attachedArea.querySelectorAll(".added_image").forEach(div => div.remove());
            if (uploadInput) uploadInput.value = "";
            updateImageCount();
            updateDeleteImagesInput();
          };
        }
        // 6. 폼 제출 시 검증
        form.addEventListener("submit", function (e) {
          updateDeleteImagesInput();
          const isDelivery = form.querySelector('input[name="isDelivery"]').checked;
          const isPickup = form.querySelector('input[name="isPickup"]').checked;
          if (!isDelivery && !isPickup) {
            e.preventDefault();
            alert("배달 또는 픽업 중 하나는 반드시 선택해야 합니다.");
          }
          ['isDelivery', 'isPickup'].forEach(name => {
            const checkbox = form.querySelector(`input[name="${name}"]`);
            if (!checkbox.checked && !form.querySelector(`input[type="hidden"][name="${name}"]`)) {
              const hidden = document.createElement("input");
              hidden.type = "hidden";
              hidden.name = name;
              hidden.value = "false";
              form.appendChild(hidden);
            }
          });
        });
        // 초기 세팅
        setupExistingImageDeleteUI();
        updateImageCount();
        updateDeleteImagesInput();
      });
    </script>
  </th:block>
</th:block>