<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<th:block th:replace="~{/layout/basic :: setContent(~{this::content} )}">
  <th:block th:fragment="content">
    <div class="estimate_container">
      <h1>
        <a href="/smash/estimate/list">ã€ˆ </a>
        ê²¬ì ì„œ ìˆ˜ì •
      </h1>
  
      <div class="estimate_form">
        <form th:action="@{/smash/estimate/modify}" enctype="multipart/form-data" method="post">
          <input type="hidden" name="idx" th:value="${dto.idx}" readonly>
          <input type="hidden" class="datetime" name="modifiedAt" readonly>

          <div id="image_preview">
            <div id="image_control">
              <label id="upload_images">
                <i class="fa-solid fa-camera"></i>
                <span><span id="image_count">0</span>/10</span>
                <input type="file" name="imageFiles" multiple hidden>
              </label>
              <p id="reset_images">ì´ë¯¸ì§€ ì´ˆê¸°í™”</p>
              <input type="hidden" name="delete_images">
            </div>
            <div class="attached_image_area">
              <div th:if="${#lists.isEmpty(dto.images)}">
              </div>
              <div class="attached_image" th:each="image : ${dto.images}">
                <img th:src="@{${image.path}}" alt="ì²¨ë¶€ ì´ë¯¸ì§€"/>
                <label>
                  <i class="remove_image fa-solid fa-xmark"></i>
                  <input type="checkbox" name="remove_check" th:value="${image.imageIdx}" hidden>
                </label>
              </div>
            </div>
          </div>

          <label for="title">ì œëª©<br>
            <input type="text" name="title" th:value="${dto.title}" required>
          </label><br>
          
          <label for="content">ë‚´ìš©<br>
            <textarea name="content" th:text="${dto.content}" required></textarea>
          </label><br>
  
          <label for="price">ê°€ê²©<br>
            <input type="text" name="price" th:value="${dto.price}" required>ì›
          </label><br>
          
          ëŒ€ì—¬ ë°©ë²•<br>
          <input type="checkbox" name="isDelivery" value="true" th:checked="${dto.isDelivery == true}">ë°°ë‹¬
          <input type="checkbox" name="isPickup" value="true" th:checked="${dto.isPickup == true}">í”½ì—…<br>
    
          ë°˜ë‚© ë‚ ì§œ<br>
          <input type="datetime-local" name="returnDate" th:value="${dto.returnDate}" required><br>
    
          <button type="submit">ìˆ˜ì • ì™„ë£Œ</button>
        </form>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // ìš”ì†Œ ëª¨ìŒ
        const form = document.querySelector("form");
        const attachedArea = document.querySelector(".attached_image_area");
        const imageCountSpan = document.getElementById("image_count");
        const uploadInput = document.querySelector('input[type="file"][name="imageFiles"]');
        const deleteInput = document.querySelector('input[type="hidden"][name="delete_images"]');
        const resetBtn = document.getElementById("reset_images");
        // ì‹œê°„ ì…ë ¥
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        const datetimeValue = now.toISOString().slice(0, 16);
        document.querySelectorAll('.datetime').forEach(input => input.value = datetimeValue);
        // 1. ì´ë¯¸ì§€ ê°œìˆ˜ í‘œì‹œ
        function updateImageCount() {
          let existingCount = 0;
          attachedArea.querySelectorAll(".attached_image").forEach(div => {
            const check = div.querySelector('input[type="checkbox"][name="remove_check"]');
            if (!check || !check.checked) existingCount++;
          });
          let addedCount = attachedArea.querySelectorAll(".added_image").length;
          imageCountSpan.textContent = existingCount + addedCount;
        }
        // 2. ì‚­ì œí•  ì´ë¯¸ì§€ ëª©ë¡ ê´€ë¦¬
        function updateDeleteImagesInput() {
          const removeIdxs = Array.from(
            attachedArea.querySelectorAll('.attached_image input[type="checkbox"][name="remove_check"]:checked')
          ).map(chk => chk.value);
          deleteInput.value = removeIdxs.join(",");
        }
        // 3. ê¸°ì¡´ ì´ë¯¸ì§€ ì‚­ì œ UI
        function setupExistingImageDeleteUI() {
          attachedArea.querySelectorAll(".attached_image").forEach(imgDiv => {
            const check = imgDiv.querySelector('input[type="checkbox"][name="remove_check"]');
            const xIcon = imgDiv.querySelector(".remove_image");
            if (!check || !xIcon) return;
            function toggle() {
              check.checked = !check.checked;
              imgDiv.classList.toggle("remove_check", check.checked);
              xIcon.className = check.checked
                ? "remove_image fa-solid fa-plus"
                : "remove_image fa-solid fa-xmark";
              updateImageCount();
              updateDeleteImagesInput();
            }
            xIcon.onclick = function (e) { e.preventDefault(); toggle(); };
            check.onchange = function () { toggle(); };
          });
        }
        // 4. ì‹ ê·œ ì´ë¯¸ì§€ ì—…ë¡œë“œ ë° ë¯¸ë¦¬ë³´ê¸°
        if (uploadInput) {
          uploadInput.addEventListener("change", function () {
            const files = Array.from(uploadInput.files);
            let existingCount = 0;
            attachedArea.querySelectorAll(".attached_image").forEach(div => {
              const check = div.querySelector('input[type="checkbox"][name="remove_check"]');
              if (!check || !check.checked) existingCount++;
            });
            let addedCount = attachedArea.querySelectorAll(".added_image").length;
            if ((existingCount + addedCount + files.length) > 10) {
              alert("ì´ë¯¸ì§€ëŠ” ìµœëŒ€ 10ê°œê¹Œì§€ ì²¨ë¶€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
              uploadInput.value = "";
              return;
            }
            files.forEach(file => {
              const reader = new FileReader();
              reader.onload = function (evt) {
                const div = document.createElement("div");
                div.className = "added_image";
                div.innerHTML = `
                  <img src="${evt.target.result}" alt="ì¶”ê°€ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°"/>
                  <i class="remove_image fa-solid fa-xmark"></i>
                `;
                div.querySelector(".remove_image").onclick = function () {
                  div.remove();
                  updateImageCount();
                };
                attachedArea.appendChild(div);
                updateImageCount();
              };
              reader.readAsDataURL(file);
            });
          });
        }
        // 5. ì´ë¯¸ì§€ ì´ˆê¸°í™” ë²„íŠ¼
        if (resetBtn) {
          resetBtn.onclick = function () {
            attachedArea.querySelectorAll(".attached_image").forEach(div => {
              const check = div.querySelector('input[type="checkbox"][name="remove_check"]');
              if (check && check.checked) {
                check.checked = false;
                div.classList.remove("remove_check");
                div.querySelector(".remove_image").className = "remove_image fa-solid fa-xmark";
              }
            });
            attachedArea.querySelectorAll(".added_image").forEach(div => div.remove());
            if (uploadInput) uploadInput.value = "";
            updateImageCount();
            updateDeleteImagesInput();
          };
        }
        // 6. í¼ ì œì¶œ ì‹œ ê²€ì¦
        form.addEventListener("submit", function (e) {
          // e.preventDefault();// ğŸŸ¢ í¼ ë°ì´í„° ì½˜ì†” ì¶œë ¥ì„ ìœ„í•´ ì œì¶œ ë§‰ê¸°
          updateDeleteImagesInput();
          const isDelivery = form.querySelector('input[name="isDelivery"]').checked;
          const isPickup = form.querySelector('input[name="isPickup"]').checked;
          // if (!isDelivery && !isPickup) {
          //   e.preventDefault();
          //   alert("ë°°ë‹¬ ë˜ëŠ” í”½ì—… ì¤‘ í•˜ë‚˜ëŠ” ë°˜ë“œì‹œ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.");
          // }
          ['isDelivery', 'isPickup'].forEach(name => {
            const checkbox = form.querySelector(`input[name="${name}"]`);
            if (!checkbox.checked && !form.querySelector(`input[type="hidden"][name="${name}"]`)) {
              const hidden = document.createElement("input");
              hidden.type = "hidden";
              hidden.name = name;
              hidden.value = "false";
              form.appendChild(hidden);
            }
          });
          // ğŸŸ¢ í¼ ë°ì´í„° ì½˜ì†” ì¶œë ¥
          // const data = new FormData(form);
          // console.log('--- FormData ì „ì†¡ ê°’ ---');
          // for (let [key, value] of data.entries()) {
          //   if (value instanceof File) {
          //     console.log(key, value.name, value.size, value.type);
          //   } else {
          //     console.log(key, value);
          //   }
          // }
        });
        // ì´ˆê¸° ì„¸íŒ…
        setupExistingImageDeleteUI();
        updateImageCount();
        updateDeleteImagesInput();
      });
    </script>
  </th:block>
</th:block>