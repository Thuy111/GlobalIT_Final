<th:block th:replace="~{/layout/basic :: setContent(~{/layout/topbar :: title(title=${title})}, ~{this::content})}">
  <th:block th:fragment="content">
    <div class="estimate_container">
      <!-- <h1>
        <a href="/smash/estimate/list">〈 </a>
        견적서 수정
      </h1> -->

      <div class="estimate_form">
        <form th:action="@{/smash/estimate/modify}" enctype="multipart/form-data" method="post">
          <input type="hidden" name="idx" th:value="${dto.idx}" readonly>
          <input type="hidden" name="requestIdx" th:value="${dto.requestIdx}" readonly>
          <input type="hidden" class="datetime" name="modifiedAt" readonly>

          <div id="image_preview_wrapper" class="image_preview_wrapper">
            <div class="camera_wrapper">   
              <label for="image_Files" class="image_upload_box">                
                <i class="fas fa-camera fa-2x"></i> 
                <span><span id="image_count">0</span>/10</span>               
              </label>              
              <button type="button" id="image_reset_btn">이미지 전체삭제</button>
            </div>
            <input type="file" id="image_Files" name="newImages" class="re_image" multiple accept="image/*" hidden />
            <div class="image_thumb" th:each="image : ${dto.images}">
              <img th:src="@{${image.path}}" alt="기존 이미지" />
              <button type="button" class="remove_btn" th:attr="data-id=${image.imageIdx}">✕</button>
            </div>
          </div>

          <label class="request_el">
            <h2>제목</h2>
            <input type="text" name="title" th:value="${dto.title}" required>
          </label>
          
          <label class="request_el">
            <h2>내용</h2>
            <textarea name="content" th:text="${dto.content}" required></textarea>
          </label>

          <label class="request_el">
            <h2>가격</h2>
            <div class="price_box">
              <input type="text" name="price" th:value="${dto.price}" required>원
            </div>
          </label>
          
          <div class="request_el">
            <h3>대여 방법</h3>
            <div class="choose_deal">
              <div class="mode"><input type="checkbox" name="isDelivery" value="true" th:checked="${dto.isDelivery == true}">배달</div>
              <div class="mode"><input type="checkbox" name="isPickup" value="true" th:checked="${dto.isPickup == true}">픽업</div>
            </div>
          </div>
    
          <div class="request_el">
            <h3>반납 날짜</h3>
            <input type="datetime-local" name="returnDate" th:value="${dto.returnDate}" required>
            <div class="calendar_box">
              <i class="fa-regular fa-calendar custom-datetime"></i>
            </div>
          </div>
    
          <div class="submit_box">
            <button type="submit" class="submit_style">수정 완료</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // 요소 모음
        const form = document.querySelector("form");
        let selectedFiles = [];
        const imageInput = document.getElementById('image_Files');
        const wrapper = document.getElementById('image_preview_wrapper');
        const countSpan = document.getElementById('image_count');

        // [1] 기존 이미지 삭제 버튼
        wrapper.querySelectorAll('.image_thumb:not(.new) .remove_btn').forEach(btn => {
          btn.onclick = function () {
            const thumb = this.closest('.image_thumb');
            thumb.remove();

            // 삭제 대상 ID hidden input으로 추가
            const deletedInput = document.createElement("input");
            deletedInput.type = "hidden";
            deletedInput.name = "deleteImageIds";  // 컨트롤러에서 처리
            deletedInput.value = this.dataset.id;
            document.querySelector("form").appendChild(deletedInput);

            updateCount();
          };
        });

        // [2] 새 이미지 추가
        imageInput.addEventListener('change', (e) => {
          const files = Array.from(e.target.files);
          if (selectedFiles.length + getOldImageCount() + files.length > 10) {
            alert("최대 10개의 이미지를 업로드할 수 있습니다.");
            imageInput.value = '';
            return;
          }
          selectedFiles = selectedFiles.concat(files);
          refreshFileInput();
          updateCount();
          renderAllThumbnails();
        });

        // [3] 썸네일 렌더링(새로 추가된 파일만)
        function renderAllThumbnails() {
          // 기존 - new 썸네일 삭제
          wrapper.querySelectorAll('.image_thumb.new').forEach(el => el.remove());
          selectedFiles.forEach((file, idx) => {
            const reader = new FileReader();
            reader.onload = (e) => {
              const thumb = document.createElement('div');
              thumb.className = 'image_thumb new';
              const img = document.createElement('img');
              img.src = e.target.result;
              const removeBtn = document.createElement('button');
              removeBtn.innerText = '✕';
              removeBtn.className = 'remove_btn';
              removeBtn.onclick = () => {
                selectedFiles.splice(idx, 1);
                refreshFileInput();
                updateCount();
                renderAllThumbnails();
              };
              thumb.appendChild(img);
              thumb.appendChild(removeBtn);
              const label = wrapper.querySelector('.camera_wrapper');
              if (label && label.nextSibling) {
                wrapper.insertBefore(thumb, label.nextSibling);
              } else {
                wrapper.appendChild(thumb);
              }
            };
            reader.readAsDataURL(file);
          });
        }

        // [4] 이미지 수 업데이트
        function updateCount() {
          countSpan.innerText = getOldImageCount() + selectedFiles.length;
        }
        function getOldImageCount() {
          return wrapper.querySelectorAll('.image_thumb:not(.new)').length;
        }

        // [5] input[type=file] 값 재설정
        function refreshFileInput() {
          const dataTransfer = new DataTransfer();
          selectedFiles.forEach(f => dataTransfer.items.add(f));
          imageInput.files = dataTransfer.files;
        }

        // [6] 전체 삭제 버튼
        document.getElementById('image_reset_btn').onclick = function () {
          const form = document.querySelector("form");
          // 기존 삭제 input 모두 삭제
          form.querySelectorAll('input[name="deleteImageIds"]').forEach(el => el.remove());
          // 기존 이미지 hidden 처리
          wrapper.querySelectorAll('.image_thumb:not(.new)').forEach(thumb => {
            const removeBtn = thumb.querySelector('.remove_btn');
            if (removeBtn && removeBtn.dataset.id) {
              const input = document.createElement('input');
              input.type = 'hidden';
              input.name = 'deleteImageIds';
              input.value = removeBtn.dataset.id;
              form.appendChild(input);
            }
          });
          // 썸네일 모두 삭제
          wrapper.querySelectorAll('.image_thumb').forEach(el => el.remove());
          selectedFiles = [];
          imageInput.value = '';
          refreshFileInput();
          updateCount();
        };

        // 날짜 입력 자동 처리
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.querySelectorAll('.datetime').forEach(input => input.value = now.toISOString().slice(0, 16));

        // 사용일 이후로 반납 날짜 설정
        const useDate = "[[${dto.useDate}]]";
        const returnDate = document.querySelector('input[name="returnDate"]');
        if (returnDate) {
          returnDate.min = useDate;
        }

        // [8] 대여 방법, 가격 필수 체크
        form.addEventListener("submit", function (e) {
          const isDelivery = form.querySelector('input[name="isDelivery"]').checked;
          const isPickup = form.querySelector('input[name="isPickup"]').checked;
          if (!isDelivery && !isPickup) {
            e.preventDefault();
            alert("배달 또는 픽업 중 하나는 반드시 선택해야 합니다.");
            return;
          }
          ['isDelivery', 'isPickup'].forEach(name => {
            const checkbox = form.querySelector(`input[name="${name}"]`);
            if (!checkbox.checked && !form.querySelector(`input[type="hidden"][name="${name}"]`)) {
              const hidden = document.createElement("input");
              hidden.type = "hidden";
              hidden.name = name;
              hidden.value = "false";
              form.appendChild(hidden);
            }
          });
          // 가격 숫자 검증(수정폼이 text라면)
          const priceInput = form.querySelector('input[name="price"]');
          if (priceInput && isNaN(Number(priceInput.value.replace(/,/g, '')))) {
            e.preventDefault();
            alert("가격은 숫자만 입력할 수 있습니다.");
            priceInput.focus();
            return;
          }
        });
        // 초기 세팅
        updateCount();
      });
    </script>
  </th:block>
</th:block>