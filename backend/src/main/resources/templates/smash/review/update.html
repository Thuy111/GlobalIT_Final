<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <link rel="stylesheet" href="/review.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
</head>
<body>
<th:block th:replace="~{/layout/basic :: setContent(~{/layout/topbar :: title(title=${title})}, ~{this::content})}">
<th:block th:fragment="content">
    <div class="review_container">
        <h2 class="hide">리뷰 수정</h2>
        <form th:action="@{/smash/review/update}" method="post"
              enctype="multipart/form-data" th:object="${review}"
              onsubmit="return confirmUpdate();">
            <!-- idx null 문제 해결: 직접 name/value 사용 -->
    <input type="hidden" name="idx" th:value="${review.idx != null} ? ${review.idx} : ''" />
    <input type="hidden" name="estimateIdx" th:value="${review.estimateIdx != null} ? ${review.estimateIdx} : ''" />
    <input type="hidden" name="requestIdx" th:value="${review.requestIdx != null} ? ${review.requestIdx} : ''" />

    <input type="hidden" name="from" th:value="${from}" />
    <input type="hidden" name="isImageReset" id="isImageReset" value="false" />

            <!-- 이미지 업로드 -->
            <div id="image_preview_wrapper" class="image_preview_wrapper">
                <div id="existing_images">
                    <div th:each="img : ${review.images}" class="image_thumb">
                        <img th:src="@{${img.path}}" alt="기존 이미지" />
                    </div>
                </div>
                <div id="new_image_previews"></div>
                <div class="camera_wrapper_box">
                    <div class="camera_wrapper">
                        <label for="image_Files" class="image_upload_box">
                            <i class="fas fa-camera fa-2x"></i>
                            <span><span id="image_count">0</span>/10</span>
                        </label>
                        <button type="button" id="image_reset_btn">이미지 초기화</button>
                    </div>
                </div>
            </div>

            <input type="file" id="image_Files" name="imageFiles" multiple hidden />

            <!-- 별점 -->
             <div class="stars_box">
                 <h3>업체에 만족하시나요?</h3>
                 <div class="star-rating" id="star-rating">
                     <input type="radio" id="star5" th:field="*{star}" value="5" />
                     <label for="star5" title="5 stars">★</label>
                     <input type="radio" id="star4" th:field="*{star}" value="4" />
                     <label for="star4" title="4 stars">★</label>
                     <input type="radio" id="star3" th:field="*{star}" value="3" />
                     <label for="star3" title="3 stars">★</label>
                     <input type="radio" id="star2" th:field="*{star}" value="2" />
                     <label for="star2" title="2 stars">★</label>
                     <input type="radio" id="star1" th:field="*{star}" value="1" />
                     <label for="star1" title="1 star">★</label>
                 </div>
             </div>

            <!-- 내용 -->
            <label for="comment">내용:</label>
            <textarea id="comment" name="comment" th:field="*{comment}" rows="5" required></textarea>

            <!-- 제출 -->
            <button type="submit">수정하기</button>
        </form>
    </div>
</th:block>
</th:block>

<script>
    let selectedFiles = [];
    const imageInput = document.getElementById('image_Files');
    const newPreviews = document.getElementById('new_image_previews');
    const countSpan = document.getElementById('image_count');

    imageInput?.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        if (selectedFiles.length + files.length > 10) {
            alert("최대 10개의 이미지를 업로드할 수 있습니다.");
            return;
        }

        files.forEach(file => {
            selectedFiles.push(file);
            renderThumbnail(file);
        });

        updateCount();
        refreshFileInput();
    });

    function renderThumbnail(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const thumb = document.createElement('div');
            thumb.className = 'image_thumb';

            const img = document.createElement('img');
            img.src = e.target.result;

            const removeBtn = document.createElement('button');
            removeBtn.innerText = '✕';
            removeBtn.className = 'remove_btn';
            removeBtn.onclick = () => {
                newPreviews.removeChild(thumb);
                selectedFiles = selectedFiles.filter(f => f !== file);
                updateCount();
                refreshFileInput();
            };

            thumb.appendChild(img);
            thumb.appendChild(removeBtn);
            newPreviews.appendChild(thumb);
        };
        reader.readAsDataURL(file);
    }

    function updateCount() {
        countSpan.innerText = selectedFiles.length;
    }

    function refreshFileInput() {
        const dataTransfer = new DataTransfer();
        selectedFiles.forEach(f => dataTransfer.items.add(f));
        if (imageInput) imageInput.files = dataTransfer.files;
    }

    document.getElementById('image_reset_btn')?.addEventListener('click', function () {
        newPreviews.innerHTML = '';
        selectedFiles = [];
        if (imageInput) imageInput.value = '';

        const existingImages = document.getElementById('existing_images');
        if (existingImages) existingImages.innerHTML = '';
        updateCount();
        refreshFileInput();

        document.getElementById('isImageReset').value = 'true';
    });

    function confirmUpdate() {
        return confirm("수정은 단 한 번만 가능합니다.\n정말 수정하시겠습니까?");
    }
</script>
</body>
</html>
