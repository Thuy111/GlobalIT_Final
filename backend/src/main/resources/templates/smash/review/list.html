<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title th:text="${title}">Î¶¨Î∑∞ Î™©Î°ù</title>
    <link rel="stylesheet" href="/reviewlist.css" />
    <script>
        function confirmDelete() {
            return confirm('Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?');
        }

        function openProfileModal(event, imageUrl) {
            event.stopPropagation();
            event.preventDefault();
            const modal = document.getElementById('profileModal');
            const modalImg = document.getElementById('modalProfileImg');
            modalImg.src = imageUrl;
            modal.classList.add('show');
        }

        function closeProfileModal() {
            document.getElementById('profileModal').classList.remove('show');
        }
    </script>
</head>
<body>

<!-- üîç ÌîÑÎ°úÌïÑ Î™®Îã¨ -->
<div id="profileModal" class="review_container modal" onclick="closeProfileModal()">
    <span class="modal-close">&times;</span>
    <img id="modalProfileImg" class="modal-img" />
</div>

<th:block th:replace="~{/layout/basic :: setContent(
                         ~{/layout/topbar :: title(title=${title})},
                         ~{this::content})}">
    <th:block th:fragment="content">
        <div class="review_container">

            <!-- ÌèâÍ∑† Î≥ÑÏ†ê -->
            <div class="review_avg_star">
                <span th:if="${avgScore != null}">
                    ‚≠ê ÌèâÍ∑† Î≥ÑÏ†ê:
                    <strong th:text="${#numbers.formatDecimal(avgScore, 1, 1)}">0.0</strong> / 5.0
                </span>
            </div>

            <!-- Î¶¨Î∑∞ Ïπ¥Îìú Î∞òÎ≥µ -->
            <div class="review_box">
                <div th:each="review : ${reviewList}"
                     th:with="
                         isOwner=${review.memberId != null and review.memberId.equals(currentUser.emailId)},
                         isAdmin=${currentUser.role == 2},
                         canModify=${(isOwner or isAdmin) and review.isModify == 0 and currentUser.emailId != null},
                         canDelete=${(isOwner or isAdmin) and currentUser.emailId != null},
                         imageUrl=${review.profileImageUrl != null and #strings.startsWith(review.profileImageUrl, '/') 
                                   ? review.profileImageUrl : '/images/profile.png'}">

                    <!-- Î¶¨Î∑∞ Ïπ¥Îìú -->
                    <a th:href="@{'/smash/request/detail/' + ${review.requestIdx}}"
                       style="text-decoration:none; color:inherit;">
                        <div class="review_card">
                            <div class="review_header">
                                <div class="review_meta">
                                    <!-- ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ -->
                                    <img th:src="@{${imageUrl}}"
                                        alt="ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ"
                                        class="review_profile_img"
                                        th:attr="data-url=${imageUrl}"
                                        onclick="openProfileModal(event, this.dataset.url)" />

                                    <span class="review_title" th:text="${review.nickname}">ÏûëÏÑ±Ïûê</span>
                                    <span class="review_star" th:text="'‚òÖ ' + ${review.star}">Î≥ÑÏ†ê</span>
                                </div>

                                <!-- ÏàòÏ†ï/ÏÇ≠Ï†ú Î≤ÑÌäº -->
                                <div class="review_actions_top">
                                    <div th:if="${canModify}">
                                        <form th:action="@{/smash/review/update}" method="get">
                                            <input type="hidden" name="reviewIdx" th:value="${review.idx}" />
                                            <input type="hidden" name="from" th:value="${(isMyList != null and isMyList) ? 'mylist' : 'list'}" />
                                            <button type="submit">ÏàòÏ†ï</button>
                                        </form>
                                    </div>

                                    <div th:if="${canDelete}">
                                        <form th:action="@{/smash/review/delete}" method="get" onsubmit="return confirmDelete();">
                                            <input type="hidden" name="reviewIdx" th:value="${review.idx}" />
                                            <input type="hidden" name="estimateIdx" th:value="${review.estimateIdx}" />
                                            <input type="hidden" name="requestIdx" th:value="${review.requestIdx}" />
                                            <input type="hidden" name="from" th:value="${(isMyList != null and isMyList) ? 'mylist' : 'list'}" />
                                            <button type="submit">ÏÇ≠Ï†ú</button>
                                        </form>
                                    </div>
                                </div>
                            </div>

                            <!-- Î¶¨Î∑∞ Ïù¥ÎØ∏ÏßÄ -->
                            <div class="review_images" th:if="${review.images != null}">
                                <img th:each="img : ${review.images}"
                                     th:src="@{${img.path}}"
                                     alt="Î¶¨Î∑∞ Ïù¥ÎØ∏ÏßÄ" />
                            </div>

                            <!-- Î¶¨Î∑∞ ÌÖçÏä§Ìä∏ -->
                            <div class="review_text">
                                <p th:text="${review.comment}">ÎÇ¥Ïö©</p>
                                <div class="review_date">
                                    [[${#temporals.format(review.createdAt, 'yyyyÎÖÑMMÏõîddÏùº HH:mm')}]]
                                    <small th:if="${review.isModify == 1}">ÏàòÏ†ïÎê®</small>
                                </div>
                            </div>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </th:block>
</th:block>
</body>
</html>
