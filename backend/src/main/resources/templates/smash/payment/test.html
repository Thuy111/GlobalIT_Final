<th:block th:replace="~{/layout/basic :: setContent(~{this::content} )}">
  <th:block th:fragment="content">
      <!-- 필요한 값들은 Thymeleaf로 동적 주입 -->
      <!-- <input type="hidden" id="memberEmail" th:value="${member.email}" />
      <input type="hidden" id="partnerBno" th:value="${partner.bno}" />
      <input type="hidden" id="estimateIdx" th:value="${estimate.idx}" /> -->
      
      <input type="hidden" id="memberEmail" th:value="'seasign10@gmail.com'" />
      <input type="hidden" id="partnerBno" th:value="'123-45-67890'" />
      <input type="hidden" id="estimateIdx" th:value="'1'" />

      <h1 style="font-size: 24px; font-weight: bold;">결제 페이지</h1>
      <hr>

      <th:block th:if="${#strings.isEmpty(impMerchantCode)}">
        <p>아임포트 가맹점 식별코드가 설정되지 않았습니다.</p>
      </th:block>
      <th:block th:unless="${#strings.isEmpty(impMerchantCode)}">
        <!-- 결제서 생성 -->
        <div class="payment-container bills" style="margin: auto; display: flex; flex-direction: column; align-items: center;">
          <div><input type="number" id="price" style="width:200px; margin: 2rem 0;" placeholder="결제 금액을 입력하세요" /> 원</div>
          <button onclick="requestBills(event)">결제 요청</button>
        </div>

        <!-- 결제 버튼들 -->
        <div class="payment-container hide" style="margin: auto; display: flex; flex-direction: column; align-items: center;">
          <div style=" margin: 2rem 0;">
            <h2><b style="font-weight: bold; margin: 1rem 0;">결제 금액</b> : <span class="price"></span>원</h2>
            <p>결제 방법을 선택해주세요.</p>
          </div>
          <div style="display: flex;">
            <button style="margin: 0.3rem;" onclick="requestPay('kakao')">카카오페이</button>
            <button style="margin: 0.3rem;" onclick="requestPay('toss')">토스</button>
            <button style="margin: 0.3rem;" onclick="requestPay('KG')">KG이니시스</button>
          </div>
        </div>

        <!-- 테스트 페이지 설명 -->
         <div style="font-size:15px; color:gray; text-align:left; width:560px; margin:1rem auto;">
          * 테스트모드 토스페이는 결제만 되고 DB적용 및 리다이렉트 되지 않으므로 <span style="color: red;">카카오페이와 KG이니시스를 권장합니다.</span><br><br>
          1) 테스트용 페이지 입니다.<br> 
          고정값의 memberEmail, partnerBno, estimateIdx가 자동 주입이 되며, 중복 결제서 처리를 확인할 수 있습니다. <br> 
          (동일한 estimateIdx로 여러 번 결제 요청 하려면 관련된 모든 결제서의 상태가 canceled 상태여야 합니다.) <br>
          혹은 DB에서 직접 지우면서 사용해야 합니다. <br>
          <br>
          2) 결제 금액은 직접 입력해야 합니다. (100원 이상) <br>
          결제 금액을 입력하고 "결제 요청" 버튼을 클릭하면 결제서가 생성됩니다. <br>
          <br>
          3) 결제서가 생성되면 결제 방법을 선택할 수 있으며, 예외 처리가 일어날 시 자동 환불이 되어야 정상입니다. <br>
          환불이 필요 할 시, Payment 담당자에게 문의 바랍니다. <br>
         </div>

      </th:block>
      

      <script>
        // 결제서 생성
        function requestBills(e) {
          e.preventDefault();

          const price = Number(document.getElementById("price").value);
          if (!price || isNaN(price)) {
            alert("유효한 금액을 입력하세요.");
            return;
          }
          if( price < 100) {
            alert("결제 금액은 100보다 커야 합니다.");
            return;
          }

          console.log(price,document.getElementById("memberEmail").value,document.getElementById("partnerBno").value,Number(document.getElementById("estimateIdx")?.value || 0))
          
          axios.post('/smash/payment/init', {
            suggestedPrice: price,
            memberEmail: document.getElementById("memberEmail").value,
            partnerBno: document.getElementById("partnerBno").value,
            estimateIdx: Number(document.getElementById("estimateIdx")?.value || 0)
          })
          .then(res => {
            console.log("결제서 생성 성공:", res.data);
          })
          .catch(err => {
            console.error("결제서 생성 실패:", err);
            alert(err.response?.data || "결제서 생성에 실패했습니다.");
            location.reload();
            return;
          });
          document.querySelector(".price").textContent = price;
          document.querySelector(".payment-container.hide").classList.remove("hide");
          document.querySelector(".payment-container.bills").classList.add("hide");
        }

        // 결제 버튼
        const IMP = window.IMP;
        IMP.init('[[${impMerchantCode}]]'); // 아임포트 가맹점 식별코드

        function requestPay(payType) {
          // 주문번호 생성
          const merchantUid = "order_" + new Date().getTime();

          // 결제 금액
          let price = document.getElementById("price").value;
          price = Number(price);

          // 결제사 요청
          let pg;
          switch(payType) {
            case 'kakao': pg = 'kakaopay'; break;
            case 'toss': pg = 'tosspay'; break;
            case 'KG': pg = 'html5_inicis'; break;   // KG이니시스
            default: pg = 'html5_inicis';
          }
          
          IMP.request_pay({
            pg: pg, // 결제 PG사
            pay_method: "card",
            merchant_uid: merchantUid, // 내가 생성한 주문번호
            name: "견적 결제",
            amount: price, // 숫자로 캐스팅 (결제 금액)
            buyer_email: "buyer@email.com",
            buyer_name: "홍길동",
            buyer_tel: "010-1234-5678",
            redirect_url: `/smash/payment/list` // 결제 완료 후 리다이렉트 URL
          }, function (rsp) {
            if (rsp.success) {
              // 결제 성공: 서버에 impUid 전달해 검증 요청
              const impUid = rsp.imp_uid;
              const memberEmail = document.getElementById("memberEmail").value;
              const partnerBno = document.getElementById("partnerBno").value;
              const estimateIdx = Number(document.getElementById("estimateIdx")?.value || 0);

              axios.get(`/smash/payment/verify/${impUid}`, {
                params: {
                  payType: payType,
                  memberEmail: memberEmail,
                  partnerBno: partnerBno,
                  estimateIdx: estimateIdx
                }
              })
              .then(res => {
                alert("결제가 완료되었습니다!");
                // 결제서 상세 페이지로 이동
                console.log("결제서 idx:", res.data);
                
                const paymentIdx = res.data;
                if(!paymentIdx) {
                  alert("결제서 상세 정보가 없습니다.");
                  return;
                }
                location.href = `/smash/payment/detail/${paymentIdx}`;
              })
              .catch((e) => {
                console.error("서버 검증 실패:", e);
                alert(e.response?.data || "결제 검증에 실패했습니다.");
              });
            } else {
              alert("결제 실패: " + rsp.error_msg);
            }
          });
        }
      </script>
  </th:block>
</th:block>

