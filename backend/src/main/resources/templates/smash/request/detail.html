<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <header>
  <!-- Bootstrap 4 CSS -->
      <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <!-- icon -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" /> 


   <!-- CSS -->
   <link rel="stylesheet" th:href="@{/request.css}" />


</header>

<th:block th:replace="~{/layout/basic :: setContent(~{this::content} )}">
  <th:block th:fragment="content">    
    <hr>
<!-- 의뢰서 상세 페이지------------------------------------------------------------------------------------------- -->
<div class="request_wrapper">
  <div class="request_header">
    <h3 class="request_title"> [[${dto.title}]]</h3>
    <span class="status_tag" th:if="${dto.isDone == 1}">낙찰 완료</span>
  </div>
  <div class="small_box">
  <!-- 이미지 -->
  <div class="attached_image_area" th:if="${not #lists.isEmpty(dto.images)}">
        <div class="attached_image" th:each="image : ${dto.images}" th:if="${image.path != null}">
          <img class="zoomable_image" th:src="@{${image.path}}" alt="첨부 이미지"/>
        </div>
  </div>
  <!-- 이미지 Lightbox (이미지 크게 보기) -->
  <div id="lightbox" class="lightbox" onclick="closeLightbox()">
    <img id="lightbox_img" src="" alt="zoom" />
  </div>

  <div class="request_content_box">
    <div class="xsmall_box">       
       <div class="hashtags">
          <span th:each="tag : ${#strings.arraySplit(dto.hashtags, ' ')}">
            #<span th:text="${tag}"></span>&nbsp;
          </span>
       </div>

      <div class="description">
        <pre th:text="${dto.content}"></pre>
      </div>     

      <div class="info">      
      <p>사용 지역: [[${dto.useRegion}]] [[${dto.detailAddress}]]</p>
      <p>사용 예정 날짜: [[${#temporals.format(dto.useDate, 'yyyy.MM.dd')}]]</p>      
      </div>
    </div>    

    <div class="created_at">작성날짜: [[${#temporals.format(dto.createdAt, 'yy.MM.dd')}]]</div>
  </div>
  </div>
</div>

  <div class="request_btn_group">
    
      <form th:action="@{/smash/request/delete}" method="post" onsubmit="return confirm('정말 삭제하시겠습니까?');"
        th:if="${dto.writerEmail != null and currentUserEmail != null and dto.writerEmail == currentUserEmail}">
        <input type="hidden" name="idx" th:value="${dto.idx}" />
        <button class="btn delete">의뢰서 삭제</button>
      </form>    
      
      <a th:if="${dto.isModify != 1 and dto.writerEmail != null and currentUserEmail != null and dto.writerEmail == currentUserEmail }"           
          th:href="@{'/smash/request/update/' + ${dto.idx}}" 
          class="btn"
          onclick="return confirm('한번만 수정가능합니다. 수정하시겠습니까?');">
          의뢰서 수정
      </a>
   
    <a class="btn" th:if="${dto.isDone == 0}" th:href="@{/smash/estimate/register(requestIdx=${dto.idx})}">
        견적서 작성
    </a>
  </div>
  <hr>

  <!-- 견적서 목록------------------------------------------------------------------------------>
  <div class="estimate_list">
    <div class="estimate_box" th:each="estimate : ${estimates}" th:with="requestDto=${dto}">
      <div class="estimate_card">
        <div class="estimate_header">
          <div class="estimate_meta">
            <span class="standby" th:if="${estimate.isSelected == 0}">낙찰 대기</span>
            <span class="unselected" th:if="${estimate.isSelected == 1}">미 낙찰</span>
            <span class="selected" th:if="${estimate.isSelected == 2}">낙찰 완료</span>
            <b class="estimate_title">[[${estimate.title}]]</b>
          </div>
          <div class="estimate_actions" th:if="${currentUser != null and estimate.partnerBno == currentUser.bno}">
            <form th:action="@{/smash/estimate/update}" method="get">
              <input type="hidden" name="idx" th:value="${estimate.idx}" />
              <button type="submit" th:if="${estimate.isSelected == 0}">수정</button>
            </form>
            <form th:action="@{/smash/estimate/delete}" method="post" th:id="'delete-'+ ${estimate.idx}">
              <input type="hidden" name="idx" th:value="${estimate.idx}" />
              <button type="submit">삭제</button>
            </form>
          </div>
        </div>
        <table>
          <tr>
            <th>제시 가격</th>
            <td>[[${estimate.price}]]원</td>
          </tr>
          <tr>
            <th>반납 기한</th>
            <td th:text="${T(java.time.format.DateTimeFormatter).ofPattern('yyyy-MM-dd HH:mm').format(estimate.returnDate)}"></td>
          </tr>
          <tr>
            <th>대여 방법</th>
            <td>
              <span class="delivery" th:if="${estimate.isDelivery == true}">배달 가능</span>
              <span class="delivery" th:if="${estimate.isDelivery == false}">배달 불가</span>
              /
              <span class="pickup" th:if="${estimate.isPickup == true}">픽업 가능</span>
              <span class="pickup" th:if="${estimate.isPickup == false}">픽업 불가</span>
            </td>
          </tr>
        </table>
        <p class="estimate_content">[[${estimate.content}]]</p>
        <div class="attached_image_area" th:if="${not #lists.isEmpty(estimate.images)}">
          <div class="attached_image" th:each="image : ${estimate.images}">
            <img th:src="@{${image.path}}" alt="첨부 이미지"/>
          </div>
        </div>
        <table>
          <caption>업체 정보</caption>
          <tr>
            <th>이름</th>
            <td th:text="${estimate.partnerName}"></td>
          </tr>
          <tr>
            <th>연락처</th>
            <td th:text="${estimate.partnerTel}"></td>
          </tr>
          <tr>
            <th>주소</th>
            <td th:text="${estimate.partnerRegion}"></td>
          </tr>
        </table>
        <p class="estimate_date">
          [[${T(java.time.format.DateTimeFormatter).ofPattern('yyyy-MM-dd HH:mm').format(estimate.modifiedAt)}]]
          <small th:if="${!estimate.createdAt.equals(estimate.modifiedAt)}">수정 됨</small>
        </p>
      </div>
      <div>
        <!-- 낙찰 버튼(+ 결제) -->
         <form>
           <div th:id="|select-${estimate.idx}|"
           th:data-request-idx="${dto.idx}"                                                                                                                                                        
           th:data-estimate-idx="${estimate.idx}"
           th:data-price="${estimate.price}"
           th:data-email="|${dto.writerEmail}|"
           th:data-bno="|${estimate.partnerBno}|">
             <input type="hidden" name="requestIdx" th:value="${dto.idx}" />
             <input type="hidden" name="estimateIdx" th:value="${estimate.idx}" />
             <input type="hidden" name="isDone" th:value="${dto.isDone}" />
             <input type="hidden" name="isSelected" th:value="2" />
             <button type="button"
             th:if="${estimate.isSelected == 0 and dto.writerEmail != null and currentUserEmail != null and dto.writerEmail == currentUserEmail}"
             onclick="handleIsDone(this)">낙찰</button>
           </div>    
         </form>
        
      <form th:action="@{/smash/request/changeIsGet}" method="post"
            th:if="${dto.isDone == 1 
                    and dto.isGet == 0
                    and estimate.isSelected == 2 
                    and dto.writerEmail != null 
                    and currentUserEmail != null 
                    and dto.writerEmail == currentUserEmail}">
        <input type="hidden" name="requestIdx" th:value="${dto.idx}" />
        <button type="submit" onclick="return confirm('대여를 확인하시겠습니까?');">대여확인</button>
      </form>        
      </div>

      <div th:if="${currentUser != null and estimate.partnerBno == currentUser.bno}">
        <form th:action="@{/smash/estimate/return}" method="post" th:id="'return-' + ${estimate.idx}">
          <input type="hidden" name="idx" th:value="${estimate.idx}" />
          <input type="hidden" name="isReturn" th:value="true" />
          <button type="submit" 
            th:if="${estimate.isReturn == false 
                  and estimate.isSelected == 2
                  and requestDto.isGet == 1 }">
                  반납 확인
          </button>
        </form>
      </div>
    </div>
  </div>
  <!-- 견적서 목록 끝------------------------------------------------------------------------------>

  <!-- 낙찰 상태 변경 + 결제 -->
  <script th:inline="javascript">
    const handleIsDone = (button) => {  
      const container = button.closest('[id^=select-]'); // id가 'select-'로 시작하는 div만 찾음
      if (!container) {
        alert("오류: 낙찰 정보를 찾을 수 없습니다.");
        return;
      }
      // data-*
      const requestIdx = container.dataset.requestIdx;
      const estimateIdx = container.dataset.estimateIdx;
      const price = container.dataset.price;
      const email = container.dataset.email;
      const bno = container.dataset.bno;

      const rIdx = Number(requestIdx);
      const eIdx = Number(estimateIdx);    

      const paymentDTO = {
        memberEmail: email,
        partnerBno: bno,
        estimateIdx: eIdx,
        suggestedPrice: Number(price)
      }                       
      const isConfirm = confirm("낙찰하시겠습니까?");
      if(isConfirm){
        axios.post(`/smash/request/changeIsDone?requestIdx=${rIdx}&estimateIdx=${eIdx}`, paymentDTO)
        .then(res => {
          console.log("결제서 생성 성공:", res.data);
          alert(res.data.message);
          window.location.href = `/smash/payment/detail/${res.data.paymentIdx}`;
      })
      .catch(err => {
        console.error("결제서 생성 실패:", err);        
        alert(err.response?.data || "결제서 생성에 실패했습니다.");        
        return;
      });
        }else{
          alert("낙찰을 취소하셨습니다.");
        }
    };
  </script>

 
  <script>
      
    document.addEventListener("DOMContentLoaded", function () {
      
      // 이미지 lightbox. Js code((이미지 크게 보기)
      const images = document.querySelectorAll(".zoomable_image");
      const lightbox = document.getElementById("lightbox");
      const lightboxImg = document.getElementById("lightbox_img");

      images.forEach(img => {
        img.addEventListener("click", () => {
          lightbox.style.display = "flex";
          lightboxImg.src = img.src;
        });
      });

      window.closeLightbox = function () {
        lightbox.style.display = "none";
        lightboxImg.src = "";
      };

      // 삭제 confirm
      const deleteForms = document.querySelectorAll("form[id^='delete-']");
      deleteForms.forEach(form => {
        form.addEventListener("submit", function (e) {
          if (!confirm("정말로 이 견적서를 삭제하시겠습니까?")) {
            e.preventDefault();
          }
        });
      });
      // 낙찰 confirm
      const selectForms = document.querySelectorAll("form[id^='select-']");
      selectForms.forEach(form => {
        form.addEventListener("submit", function (e) {
          if (!confirm("이 견적서를 낙찰 처리하시겠습니까?")) {
            e.preventDefault();
          }
        });
      });
      // 반납 confirm
      const returnForms = document.querySelectorAll("form[id^='return-']");
      returnForms.forEach(form => {
        form.addEventListener("submit", function (e) {
          if (!confirm("반납을 확인 처리하시겠습니까?")) {
            e.preventDefault();
          }
        });
      });
    });
  </script>
  <!-- 의뢰서 상세 페이지.End-->

  </th:block>
</th:block>