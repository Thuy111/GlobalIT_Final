
<th:block th:replace="~{/layout/basic :: setContent(~{/layout/topbar :: title(title=${title})}, ~{this::content})}">
  <th:block th:fragment="content">    
    <!-- 의뢰서 상세 페이지------------------------------------------------------------------------------------------- -->
    <div class="request_wrapper">
      <div class="request_header">
        <h3 class="request_title"> [[${dto.title}]]</h3>
        <span class="status_tag" th:if="${dto.isDone == 1}">낙찰 완료</span>
      </div>
      <hr class="estimate_divider" />
      <div class="name_created_box">
        <div class="writer_info">
          <div class="nickname_box">
            <span style="width: 22px;">
              <i class="fa-solid fa-user"></i>
            </span>
            <span class="nickname" th:text="${writerNickname}"></span>
          </div>
          <span class="icon_box"
          th:if="${currentUser != null and 
                   currentUser.emailId != null and 
                   dto.writerEmail != null and 
                   currentUser.emailId != dto.writerEmail and
                   currentUser.role != 0}"
          th:attr="data-member-user=${dto.writerEmail}, data-partner-user=${currentUser != null ? currentUser.emailId : ''}"
          onclick="handleCreateRoom(this)"><i class="fa-regular fa-comments"></i> 1:1 채팅하기</span>
        </div>
        <div class="created_at_box">
          <div class="created_at">[[${T(java.time.format.DateTimeFormatter).ofPattern('yyyy년 MM월 dd일').format(dto.createdAt)}]]</div>
          <div class="created_at">[[${T(java.time.format.DateTimeFormatter).ofPattern('HH:mm').format(dto.createdAt)}]]</div>
        </div>
      </div>

      <div class="small_box">
        <!-- 이미지 -->
        <div class="attached_image_area" th:if="${not #lists.isEmpty(dto.images)}">
          <div class="attached_image" th:each="image : ${dto.images}" th:if="${image.path != null}">
            <img class="zoomable_image" th:src="@{${image.path}}" alt="첨부 이미지"/>
          </div>
        </div>
        <!-- 이미지 Lightbox (이미지 크게 보기) -->
        <div id="lightbox" class="lightbox" onclick="closeLightbox()">
          <img id="lightbox_img" src="" alt="zoom" />
        </div>
        <div class="request_content_box">
          <div class="xsmall_box">       
            <div class="hashtags">
              <span th:each="tag : ${#strings.arraySplit(dto.hashtags, ' ')}">
                #<span th:text="${tag}"></span>&nbsp;
              </span>
            </div>
            <div class="description">
              <pre th:text="${dto.content}"></pre>
            </div>     
            <div class="info">                   
            <!-- 조소: 작성자,낙찰된 업체(배송 가능)만 상세 주소 -->             
            <div class="badge_area">
              <div class="badge_area"><span class="badge">사용 지역</span>
                <span>[[${dto.useRegion}]]
                  <span th:if="${(dto.isDone == 1 and 
                                  currentUser != null and 
                                  winnerBno != null and 
                                  #strings.equals(currentUser.bno, winnerBno) and 
                                  selectedEstimate != null and 
                                  selectedEstimate.isDelivery == true) or 
                                 (dto.writerEmail != null and currentUser != null and dto.writerEmail == currentUser.emailId) }">
                    [[${dto.detailAddress}]]
                  </span>
                </span>
              </div>
            </div>

            <div class="badge_area"><span class="badge">사용 예정 날짜</span><span>[[${T(java.time.format.DateTimeFormatter).ofPattern('yyyy년 MM월 dd일 HH:mm').format(dto.useDate)}]]</span></div>      
            </div>                    
          </div>    
        </div>
      </div>
    </div>
 
    <div class="request_button_group">
      <!-- 의뢰서 작성한 자만 보이는 버튼 -->
      <div th:if="${dto.isDone == 0 and
                   (dto.writerEmail != null and currentUser != null and dto.writerEmail == currentUser.emailId) or 
                   (currentUser != null and currentUser.role == 2)}">
        <form th:action="@{/smash/request/delete}" method="post" onsubmit="return confirm('정말 삭제하시겠습니까?');">
          <input type="hidden" name="idx" th:value="${dto.idx}" />          
          <button class="btn delete">의뢰서 삭제</button>
        </form>        
        <a th:href="@{'/smash/request/update/' + ${dto.idx}}" class="btn" onclick="return confirm('한번만 수정가능합니다. 수정하시겠습니까?');"
         th:if="${dto.isModify != 1}">
          의뢰서 수정
        </a>
      </div>
      
      <!-- 업체만 보이는 견적서 작성 버튼 -->
      <a class="btn"
         th:href="@{/smash/estimate/register(requestIdx=${dto.idx})}"
         th:if="${(dto.isDone == 0 and 
                   currentUser != null and 
                   currentUser.role == 1 and 
                   dto.writerEmail != currentUser.emailId) or 
                  (currentUser != null and currentUser.role == 2)}">
        견적서 작성
      </a>
    </div>

    <!-- 견적서 목록------------------------------------------------------------------------------>
    <hr class="estimate_divider" />
    <h2 class="estimates_title" th:if="${estimates.size()==0}">받은 견적서 목록이 없습니다.</h2>
    <h2 class="estimates_title" th:if="${estimates.size()>0}">받은 견적서 목록 (<span th:text="${estimates.size()}"></span>)</h2>
    <div class="estimate_list">
      <div class="estimate_box" th:each="estimate : ${estimates}" th:with="requestDto=${dto}">
        <div class="estimate_card">
          <div class="estimate_header">
            <div class="estimate_meta">
              <b class="estimate_title">[[${estimate.title}]]</b>
              <span class="standby" th:if="${estimate.isSelected == 0}">낙찰 대기</span>
              <span class="unselected" th:if="${estimate.isSelected == 1}">미 낙찰</span>
              <span class="selected" th:if="${estimate.isSelected == 2}">낙찰 완료</span>
            </div>
            
          </div>
          
          <div class="estimate_body">
            <div class="estimate_actions" th:if="${(currentUser != null and currentUser.role == 1 and currentUser.bno == estimate.partnerBno) or 
                                                   (currentUser != null and currentUser.role == 2)}">
              <form th:action="@{/smash/estimate/update}" method="get">
                <input type="hidden" name="idx" th:value="${estimate.idx}" />
                <button type="submit" th:if="${estimate.isSelected == 0}" class="update">수정</button>
              </form>
              <form th:action="@{/smash/estimate/delete}" method="post" th:id="'delete-'+ ${estimate.idx}">
                <input type="hidden" name="idx" th:value="${estimate.idx}" />
                <button type="submit" class="delete">삭제</button>
              </form>
            </div>
            <div class="estimate_info">
              <div>
                <span class="badge">제시 가격</span>
                <div style="font-size: 18px;"><span class="price">[[${#numbers.formatInteger(estimate.price, 3, 'COMMA')}]]</span> 원</div>
              </div>
              <div>
                <span class="badge">반납 기한</span>
                <span>[[${T(java.time.format.DateTimeFormatter).ofPattern('yyyy년 MM월 dd일 HH:mm').format(estimate.returnDate)}]]</span>
              </div>
              <div>
                <span class="badge">대여 방법</span>
                <p class="deal_method">
                  <span class="delivery yes" th:if="${estimate.isDelivery == true}">배달 가능</span>
                  <span class="delivery no" th:if="${estimate.isDelivery == false}">배달 불가</span>
                  <span class="pickup yes" th:if="${estimate.isPickup == true}">픽업 가능</span>
                  <span class="pickup no" th:if="${estimate.isPickup == false}">픽업 불가</span>
                </p>
              </div>
              <div class="estimate_content">
                <pre>[[${estimate.content}]]</pre>
              </div>
            </div>
            <div class="attached_image_area" th:if="${not #lists.isEmpty(estimate.images)}">
              <div class="attached_image" th:each="image : ${estimate.images}">
                <img class="zoomable_image" th:src="@{${image.path}}" alt="첨부 이미지"/>
              </div>
            </div>
            <div id="lightbox" class="lightbox" onclick="closeLightbox()">
              <img id="lightbox_img" src="" alt="zoom" />
            </div>
            <div class="partner_info">
              <div class="partner_name"
                  th:with="frontendUrl=${@environment.getProperty('front.server.url')}"
                  th:attr="data-href=${frontendUrl + '/store/' + estimate.partnerCode}"
                  onclick="window.location.href=this.getAttribute('data-href');">
                <div class="store_icon_box">
                  <i class="fa-solid fa-store"></i>
                </div>
                <p class="name" th:text="${estimate.partnerName}"></p>
              </div>
              <div class="patner_tel">
                <span class="badge">연락처</span>
                <span class="tel" th:text="${estimate.partnerTel}"></span>
              </div>
              <div>
                <span class="badge">주소</span>
                <span th:text="${estimate.partnerRegion}"></span>
              </div>
            </div>
            <p class="estimate_date">
              [[${T(java.time.format.DateTimeFormatter).ofPattern('yyyy년 MM월 dd일 HH:mm').format(estimate.modifiedAt)}]]
              <small th:if="${!estimate.createdAt.equals(estimate.modifiedAt)}">(수정 됨)</small>
            </p>
          </div>
          
          <!-- 리뷰 -->
          <th:block th:if="${estimateReviewMap != null and estimateReviewMap[estimate.idx] != null and !#lists.isEmpty(estimateReviewMap[estimate.idx])}">
            <div class="review_box">
              <div class="review_badge">후기</div>
              <hr>
              <div th:replace="~{smash/request/review :: reviewCards(${estimateReviewMap[estimate.idx]}, ${currentUser}, ${estimate.idx}, ${false})}"></div>
            </div>
          </th:block>
          
        </div>
        <!-- 의뢰서 작성자가 처리하는 버튼 모음--------------------------------------------------------->
        <div th:if="${(dto.writerEmail != null and 
                       currentUser != null and 
                       dto.writerEmail == currentUser.emailId) or 
                      (currentUser != null and currentUser.role == 2)}">
          <!-- 낙찰 버튼(+ 결제) -->
          <form class="estimate_actions select_form">
            <div th:id="|select-${estimate.idx}|"
                  th:data-request-idx="${dto.idx}"                                                                                                                                                        
                  th:data-estimate-idx="${estimate.idx}"
                  th:data-price="${estimate.price}"
                  th:data-email="|${dto.writerEmail}|"
                  th:data-bno="|${estimate.partnerBno}|">
              <input type="hidden" name="requestIdx" th:value="${dto.idx}" />
              <input type="hidden" name="estimateIdx" th:value="${estimate.idx}" />
              <input type="hidden" name="isDone" th:value="${dto.isDone}" />
              <input type="hidden" name="isSelected" th:value="2" />
              <button type="button"
                      th:if="${estimate.isSelected == 0}"
                      onclick="handleIsDone(this)">
                낙찰
              </button>
            </div>    
          </form>
          <!--대여확인 버튼  --> 
          <form th:action="@{/smash/request/changeIsGet}" method="post" class="estimate_actions select_form"
                th:if="${dto.isDone == 1 and 
                         dto.isGet == 0 and 
                         estimate.isSelected == 2}">
            <input type="hidden" name="requestIdx" th:value="${dto.idx}" />
            <button type="submit" onclick="return confirm('대여를 확인하시겠습니까?');">대여확인</button>
          </form>
          <!-- 리뷰 버튼(한번만 리뷰 가능) -->        
          <form th:action="@{/smash/review/register}" method="get" class="estimate_actions select_form"
                th:if="${estimate.isSelected == 2 and 
                         dto.isGet == 1 and 
                         reviewStatusMap != null and 
                        (reviewStatusMap[estimate.idx] == null or !reviewStatusMap[estimate.idx])}">
            <input type="hidden" name="estimateIdx" th:value="${estimate.idx}" />
            <button type="submit">리뷰 작성</button>
          </form>
        </div><!-- 의뢰서 작성자가 처리하는 버튼 모음 끝--------------------------------------------------------->
        <!-- 견적서 작성자가 처리하는 (반납확인) 버튼 -->
        <div th:if="${(currentUser != null and estimate.partnerBno == currentUser.bno) or 
                      (currentUser != null and currentUser.role == 2)}">
          <form th:action="@{/smash/estimate/return}" method="post" th:id="'return-' + ${estimate.idx}" class="estimate_actions select_form">
            <input type="hidden" name="idx" th:value="${estimate.idx}" />
            <input type="hidden" name="isReturn" th:value="true" />
            <button type="submit" 
              th:if="${estimate.isReturn == false and 
                       estimate.isSelected == 2 and 
                       requestDto.isGet == 1 }">
              반납 확인
            </button>
          </form>
        </div><!-- 견적서 작성자가 처리하는 (반납확인) 버튼 끝 -->
      </div>
    </div>

    <div class="bottom_space"></div>
    <!-- 견적서 목록 끝------------------------------------------------------------------------------>
      <!-- 모달 HTML: 프로필 이미지 클릭 시 뜨는 모달 -->
  <div id="profileModal" class="modal" onclick="closeProfileModal()">
    <span class="modal-close">&times;</span>
    <img id="modalProfileImg" class="modal-img" />
  </div>
  
    <script th:inline="javascript">
      const nickname = /*[[${writerNickname}]]*/ '';
      const currentUser = /*[[${currentUser.emailId}]]*/ null;

      // 채팅방 함수
      const handleCreateRoom = async (el) => {
        const memberUser = el.getAttribute('data-member-user');
        const partnerUser = el.getAttribute('data-partner-user');
        console.log('채팅방 생성 요청:', memberUser, partnerUser);

        if(!memberUser || !partnerUser || memberUser === partnerUser) {
          alert("채팅방 생성에 실패했습니다. 문제가 지속될 시, 문의해주세요.");
          return;
        }

        if(confirm(`${nickname}님과 1:1 채팅`) === false) {
          return;
        }
        window.location.href = `/smash/chat/chatRoomInit?user=${memberUser}`;
      };

      // 낙찰 상태 변경 및 결제서 생성
      const handleIsDone = (button) => {  
        const container = button.closest('[id^=select-]'); // id가 'select-'로 시작하는 div만 찾음
        if (!container) {
          alert("오류: 낙찰 정보를 찾을 수 없습니다.");
          return;
        }
        // data-*
        const requestIdx = container.dataset.requestIdx;
        const estimateIdx = container.dataset.estimateIdx;
        const price = container.dataset.price;
        const email = container.dataset.email;
        const bno = container.dataset.bno;

        const rIdx = Number(requestIdx);
        const eIdx = Number(estimateIdx);       
       
        const paymentDTO = {
          memberEmail: email,
          partnerBno: bno,
          estimateIdx: eIdx,
          suggestedPrice: Number(price)
        }                
        
        const isConfirm = confirm("낙찰하시겠습니까?");
        if(isConfirm){
          axios.post(`/smash/request/changeIsDone?requestIdx=${rIdx}&estimateIdx=${eIdx}`, paymentDTO)
               .then(res => {console.log("결제서 생성 성공:", res.data);
                             alert(res.data.message);
                             window.location.href = `/smash/payment/detail/${res.data.paymentIdx}`;
          }).catch(err => {console.error("결제서 생성 실패:", err);        
                           alert(err.response?.data || "결제서 생성에 실패했습니다.");        
                           return;});
        }else{
          alert("낙찰을 취소하셨습니다.");
        }
      };

      document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll('.tel').forEach(function(el){
          let tel = el.textContent.trim();
          tel = tel.replace(/[^\d]/g, '');
          // 02로 시작, 9자리: 02-XXX-YYYY
          if (tel.startsWith("02") && tel.length === 9) {
            tel = tel.replace(/^(\d{2})(\d{3})(\d{4})$/, "$1-$2-$3");
          }
          // 02로 시작, 10자리: 02-XXXX-YYYY
          else if (tel.startsWith("02") && tel.length === 10) {
            tel = tel.replace(/^(\d{2})(\d{4})(\d{4})$/, "$1-$2-$3");
          }
          // 휴대폰 11자리: 010-XXXX-YYYY
          else if (tel.length === 11) {
            tel = tel.replace(/^(\d{3})(\d{4})(\d{4})$/, "$1-$2-$3");
          }
          // 0XX로 시작, 10자리: 0XX-XXX-YYYY or 0XX-XXXX-YYY
          else if (tel.length === 10) {
            tel = tel.replace(/^(\d{3})(\d{3,4})(\d{4})$/, "$1-$2-$3");
          }
          el.textContent = tel;
        });

        // 이미지 lightbox. Js code((이미지 크게 보기)
        const images = document.querySelectorAll(".zoomable_image");
        const lightbox = document.getElementById("lightbox");
        const lightboxImg = document.getElementById("lightbox_img");

        images.forEach(img => {
          img.addEventListener("click", () => {
            lightbox.style.display = "flex";
            lightboxImg.src = img.src;
          });
        });

        window.closeLightbox = function () {
          lightbox.style.display = "none";
          lightboxImg.src = "";
        };

        // 삭제 confirm
        const deleteForms = document.querySelectorAll("form[id^='delete-']");
        deleteForms.forEach(form => {
          form.addEventListener("submit", function (e) {
            if (!confirm("정말로 이 견적서를 삭제하시겠습니까?")) {
              e.preventDefault();
            }
          });
        });

        // 낙찰 confirm
        const selectForms = document.querySelectorAll("form[id^='select-']");
        selectForms.forEach(form => {
          form.addEventListener("submit", function (e) {
            if (!confirm("이 견적서를 낙찰 처리하시겠습니까?")) {
              e.preventDefault();
            }
          });
        });

        // 반납 confirm
        const returnForms = document.querySelectorAll("form[id^='return-']");
        returnForms.forEach(form => {
          form.addEventListener("submit", function (e) {
            if (!confirm("반납을 확인 처리하시겠습니까?")) {
              e.preventDefault();
            }
          });
        });

      });

      // 리뷰 프로필이미지 모달 열기
      function openProfileModal(imageUrl) {
        const modal = document.getElementById('profileModal');
        const modalImg = document.getElementById('modalProfileImg');
        modalImg.src = imageUrl;
        modal.style.display = 'flex';
      }

      // 프로필 모달 닫기
      function closeProfileModal() {
        const modal = document.getElementById('profileModal');
        modal.style.display = 'none';
      }
    </script>
    <!-- 의뢰서 상세 페이지.End-->
  </th:block>
</th:block>
